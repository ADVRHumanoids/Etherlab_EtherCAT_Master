From c4dc73d02510553f23332bfcb6af0d5936c41cd7 Mon Sep 17 00:00:00 2001
From: Nikola Zivkovic <zivke85@gmail.com>
Date: Mon, 31 Oct 2022 17:33:25 +0100
Subject: [PATCH 1/3] Fix error handling for SII write

---
 lib/master.c | 17 ++++++++++-------
 1 file changed, 10 insertions(+), 7 deletions(-)

diff --git a/lib/master.c b/lib/master.c
index 5468a75c..314aa0ba 100644
--- a/lib/master.c
+++ b/lib/master.c
@@ -1120,17 +1120,20 @@ int ecrt_master_write_sii(ec_master_t *master, uint16_t position,
     data.words = malloc(size * sizeof(uint8_t));
     memcpy((uint8_t *)data.words, content, size);
 
-    int ret;
-
-    ret = ioctl(master->fd, EC_IOCTL_SLAVE_SII_WRITE, &data);
-    if (EC_IOCTL_IS_ERROR(ret)) {
-        EC_PRINT_ERR("Failed to write SII: %s\n",
-                     strerror(EC_IOCTL_ERRNO(ret)));
+    int error = ioctl(master->fd, EC_IOCTL_SLAVE_SII_WRITE, &data);
+    if (EC_IOCTL_IS_ERROR(error)) {
+        error = EC_IOCTL_ERRNO(error);
+    } else {
+        /**
+         * A few ioctl() requests use the return value as an output parameter
+         * and return a nonnegative value on success
+         */
+        error = 0;
     }
 
     free(data.words);
 
-    return ret;
+    return error;
 }
 
 /****************************************************************************/
-- 
2.34.1

